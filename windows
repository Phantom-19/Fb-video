import os
import json
import time
import base64
import requests
import win32gui, win32con
from bs4 import BeautifulSoup
from win10toast import ToastNotifier

credentials = {
    'username' : '',
    'password' : ''
}

while True:
    try:
        if os.path.exists('creds.json'):
            with open('creds.json', 'r') as f:
                data = json.load(f)

                nomu = data['username']
                mdp = data['password']

                nomu_decrypter = base64.b64decode(nomu.encode())
                mdp_decrypter = base64.b64decode(mdp.encode())

                url = 'https://www.lankabell.com/lte/home1.jsp'
                data = {'logName': nomu_decrypter, 'redirectFUP': 'null','password': mdp_decrypter, 'logtype': 'login', 'submit': 'Sign In'}

                session = requests.session()
                response = session.post(url,data=data).content.decode('utf-8')
                x = session.cookies.get_dict() 
                soup = BeautifulSoup(response, 'lxml')
                error = soup.find('div', {'id':'result'})

                if not error:
                    try:
                        frgrnd_wndw = win32gui.GetForegroundWindow();
                        wndw_title  = win32gui.GetWindowText(frgrnd_wndw);
                        if wndw_title.endswith("lankabell_usage_notify.exe"):
                            win32gui.ShowWindow(frgrnd_wndw, win32con.SW_HIDE);
                    except Exception:
                        pass

                    toaster = ToastNotifier()
                    span = soup.find_all('span', {'class':'styleCommon'})

                    days = span[10].text

                    url2 = 'https://www.lankabell.com/lte/usage.jsp'

                    t = requests.post(url2, cookies=x).content.decode('utf-8')

                    soup = BeautifulSoup(t, 'lxml')

                    spans = soup.find_all('span', {'class' : 'styleCommon'})

                    monthly_anytime = spans[0].text
                    monthly_offpeak = spans[1].text

                    m_combine = monthly_anytime + "\n" + monthly_offpeak

                    remaining_anytime = spans[2].text
                    remaining_offpeak = spans[3].text

                    r_combine = remaining_anytime + "\n" + remaining_offpeak + "\n" + "Période de validité des données: " + days

                    toaster.show_toast("Monthly Usage",
                                    m_combine,
                                    icon_path="fav.ico",
                                    duration=6,
                                    )

                    toaster.show_toast("Remaining Data",
                                    r_combine,
                                    icon_path="fav.ico",
                                    duration=6,
                                    )

                    time.sleep(3600)

                else:
                    nomu = str(input("Nom utilisateur: "))
                    mdp = str(input("Mot de passe: "))
                    
                    nomu_crypter = base64.b64encode(nomu.encode())
                    mdp_crypter = base64.b64encode(mdp.encode())

                    credentials['username'] = nomu_crypter.decode()
                    credentials['password'] = mdp_crypter.decode()

                    with open('creds.json', 'w') as f:
                       json.dump(credentials, f)
        else:
            nomu = str(input("Nom utilisateur: "))
            mdp = str(input("Mot de passe: "))

            nomu_crypter = base64.b64encode(nomu.encode())
            mdp_crypter = base64.b64encode(mdp.encode())

            credentials['username'] = nomu_crypter.decode()
            credentials['password'] = mdp_crypter.decode()

            with open('creds.json', 'w') as f:
                json.dump(credentials, f)

    except Exception:
        quit()
